<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <title>Gerador de Imagem</title>
  <style>
    body { font-family: Arial, sans-serif; padding: 20px; }
    input, textarea, button { margin-top: 10px; display: block; width: 100%; max-width: 400px; }
    canvas { display: none; margin-top: 20px; }
  </style>
</head>
<body>
  <h1>Gerar Imagem para Redes</h1>
  <input type="file" id="imageInput" accept="image/jpeg, image/png" required />
  <textarea id="caption" placeholder="Digite a legenda"></textarea>
  <button onclick="generateImage()">Gerar PNG</button>
  <a id="downloadLink" style="display:none;" download="imagem_gerada.png">Baixar imagem</a>
  <canvas id="finalCanvas" width="1440" height="959"></canvas>

  <script>
    async function generateImage() {
      const imageInput = document.getElementById("imageInput").files[0];
      const caption = document.getElementById("caption").value.trim();
      const canvas = document.getElementById("finalCanvas");
      const ctx = canvas.getContext("2d");

      if (!imageInput || !caption) {
        alert("Selecione uma imagem e digite a legenda.");
        return;
      }

      const headerImg = await loadImage("cabeçalhoredes.png");
      const footerImg = await loadImage("rodaperedes.png");
      const userImg = await loadImage(URL.createObjectURL(imageInput));

      const headerHeight = 102;
      const footerHeight = 55;
      const totalHeight = 959;
      const totalWidth = 1440;
      const contentHeight = totalHeight - headerHeight - footerHeight;

      // Fundo branco
      ctx.fillStyle = "white";
      ctx.fillRect(0, 0, totalWidth, totalHeight);

      // Cabeçalho centralizado
      const headerX = (totalWidth - headerImg.width) / 2;
      ctx.drawImage(headerImg, headerX, 0);

      // Rodapé centralizado
      const footerX = (totalWidth - footerImg.width) / 2;
      ctx.drawImage(footerImg, footerX, totalHeight - footerHeight);

      // Crop centralizado da imagem do usuário
      const cropWidth = userImg.width;
      const cropHeight = userImg.height;
      const cropRatio = cropWidth / cropHeight;
      const targetRatio = totalWidth / contentHeight;

      let sx, sy, sw, sh;
      if (cropRatio > targetRatio) {
        // imagem mais larga
        sh = cropHeight;
        sw = cropHeight * targetRatio;
        sx = (cropWidth - sw) / 2;
        sy = 0;
      } else {
        // imagem mais alta
        sw = cropWidth;
        sh = cropWidth / targetRatio;
        sx = 0;
        sy = (cropHeight - sh) / 2;
      }

      ctx.drawImage(userImg, sx, sy, sw, sh, 0, headerHeight, totalWidth, contentHeight);

      // Legenda com fundo azul
      ctx.font = "30px Arial";
      ctx.fillStyle = "blue";
      const textWidth = ctx.measureText(caption).width + 20;
      const textHeight = 40;
      const textX = 20;
      const textY = headerHeight + 20;

      ctx.fillRect(textX, textY, textWidth, textHeight);
      ctx.fillStyle = "yellow";
      ctx.fillText(caption, textX + 10, textY + 28);

      // Mostrar e permitir download
      const downloadLink = document.getElementById("downloadLink");
      downloadLink.href = canvas.toDataURL("image/png");
      downloadLink.style.display = "inline-block";
      downloadLink.textContent = "Baixar imagem gerada";
    }

    function loadImage(src) {
      return new Promise((resolve, reject) => {
        const img = new Image();
        img.onload = () => resolve(img);
        img.onerror = reject;
        img.src = src;
      });
    }
  </script>
</body>
</html>
