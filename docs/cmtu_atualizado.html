<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <title>Requerimento - CMTU</title>

  <!-- jsPDF e plugins -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.28/jspdf.plugin.autotable.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>

  <style>
    /* Seu estilo vai aqui */
  </style>
</head>
<body>
  <form id="formulario">
    <!-- Seu formulário vai aqui -->
  </form>

  <script>
    // Adicione os scripts que você já tem aqui (do seu código original)
    
    // Função para salvar dados no localStorage
    function salvarNoLocalStorage(dados) {
      let historico = JSON.parse(localStorage.getItem("requerimentos")) || [];
      historico.push(dados);
      localStorage.setItem("requerimentos", JSON.stringify(historico));
    }

    // Função para mostrar o histórico
    function mostrarHistorico() {
      const historico = JSON.parse(localStorage.getItem("requerimentos")) || [];
      const div = document.getElementById("historico");
      div.innerHTML = "<h3>Histórico de Requerimentos</h3>";

      if (historico.length === 0) {
        div.innerHTML += "<p>Nenhum requerimento salvo ainda.</p>";
        return;
      }

      historico.forEach((item, index) => {
        div.innerHTML += `
          <div style="border: 1px solid #ccc; padding: 10px; margin-bottom: 10px; background: #fff;">
            <strong>${index + 1}) ${item.nome}</strong><br>
            <em>${item.data}</em><br>
            Motivo: ${item.motivo}<br>
            Renda Total: R$ ${item.renda_total}<br>
            Per Capita: R$ ${item.renda_per_capita}<br>
            Familiares: ${item.familiares.map(f => f.nome).join(", ")}
          </div>
        `;
      });
    }

    // Função para limpar o histórico
    function limparHistorico() {
      if (confirm("Tem certeza que deseja apagar todo o histórico?")) {
        localStorage.removeItem("requerimentos");
        mostrarHistorico();
      }
    }

    // Função para exportar para CSV
    function exportarCSV() {
      const historico = JSON.parse(localStorage.getItem("requerimentos")) || [];
      if (historico.length === 0) {
        alert("Nenhum dado para exportar.");
        return;
      }

      let csv = "Nome,Motivo,Data,Renda Total,Renda Per Capita,Familiares\n";
      historico.forEach(item => {
        csv += `"${item.nome}","${item.motivo}","${item.data}","${item.renda_total}","${item.renda_per_capita}","${item.familiares.map(f => f.nome).join(" / ")}"\n`;
      });

      const blob = new Blob([csv], { type: "text/csv" });
      const url = URL.createObjectURL(blob);
      const a = document.createElement("a");
      a.href = url;
      a.download = "historico_requerimentos.csv";
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
    }

    // Função para adicionar familiar ao formulário
    let contadorFamilia = 0;
    function adicionarFamiliar() {
      if (contadorFamilia >= 12) return alert("Limite de 12 familiares atingido.");

      const div = document.createElement('div');
      div.className = 'familia';
      div.innerHTML = `
        <label>Nome: <input name="nome_familiar"></label>
        <label>Idade: <input name="idade_familiar"></label>
        <label>Vínculo: <input name="vinculo_familiar"></label>
        <label>Profissão: <input name="profissao_familiar"></label>
        <label>Renda: <input name="renda_familiar" type="number" step="0.01"></label>
      `;
      document.getElementById('familiares').appendChild(div);
      contadorFamilia++;
    }

    // Função para gerar o PDF
    document.getElementById('formulario').addEventListener('submit', async (e) => {
      e.preventDefault();

      const { jsPDF } = window.jspdf;
      const doc = new jsPDF();

      const form = new FormData(e.target);
      const diasSelecionados = Array.from(document.querySelectorAll('input[name="dias"]:checked')).map(el => el.value).join(", ");
      const dataAtual = new Date().toLocaleDateString();

      let rendaTotal = 0;
      const familiares = Array.from(document.querySelectorAll('.familia')).map(div => {
        const nome = div.querySelector('[name="nome_familiar"]').value;
        const idade = div.querySelector('[name="idade_familiar"]').value;
        const vinculo = div.querySelector('[name="vinculo_familiar"]').value;
        const profissao = div.querySelector('[name="profissao_familiar"]').value;
        const renda = parseFloat(div.querySelector('[name="renda_familiar"]').value) || 0;
        rendaTotal += renda;
        return { nome, idade, vinculo, profissao, renda };
      });
      const perCapita = familiares.length ? (rendaTotal / familiares.length).toFixed(2) : "0.00";

      const unificado = await loadImageBase64('unificado.jpg');
      const guarda = await loadImageBase64('guarda.jpg');
      doc.addImage(unificado, 'JPEG', 10, 10, 40, 20);
      doc.addImage(guarda, 'JPEG', 160, 10, 40, 20);
      doc.setFontSize(14);
      doc.text("REQUERIMENTO", 105, 20, null, null, 'center');

      let y = 40;
      doc.setFontSize(10);

      const texto1 = `Eu, ${form.get("nome")}, portador do RG ${form.get("rg")} e CPF ${form.get("cpf")}, residente à ${form.get("rua")}, CEP ${form.get("cep")}, no bairro ${form.get("bairro")}, telefone ${form.get("telefone")}, venho por meio deste requerer...`;
      doc.text(texto1, 10, y);
      y += 10;

      const texto2 = `Dias Selecionados: ${diasSelecionados}`;
      doc.text(texto2, 10, y);
      y += 10;

      const texto3 = `Horários: ${form.get("entrada")} - ${form.get("saida")}`;
      doc.text(texto3, 10, y);
      y += 10;

      const texto4 = `Linhas de Ônibus: ${form.get("linhas")}`;
      doc.text(texto4, 10, y);
      y += 10;

      const texto5 = `Renda Total: R$ ${rendaTotal.toFixed(2)} | Per Capita: R$ ${perCapita}`;
      doc.text(texto5, 10, y);
      y += 10;

      // Adicionar dados dos familiares ao PDF
      familiares.forEach(f => {
        doc.text(`Familiar: ${f.nome} | Idade: ${f.idade} | Vínculo: ${f.vinculo} | Profissão: ${f.profissao} | Renda: R$ ${f.renda.toFixed(2)}`, 10, y);
        y += 10;
      });

      // Gerar o PDF
      doc.save(`Requerimento_${form.get("nome")}_${dataAtual}.pdf`);
      salvarNoLocalStorage({
        nome: form.get("nome"),
        motivo: form.get("motivo"),
        data: dataAtual,
        renda_total: rendaTotal.toFixed(2),
        renda_per_capita: perCapita,
        familiares
      });
    });
  </script>
</body>
</html>
